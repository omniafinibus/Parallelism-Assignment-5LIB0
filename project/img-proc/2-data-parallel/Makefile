# skip system vep_0 which is handled by Makefile dependencies in tools & vep_x
VEPS := $(wildcard vep_[1-9]*)
TOOLS := ./tools
TOOLSSRC := $(wildcard $(TOOLS)/*.[ch])

all: tools $(foreach v, $(VEPS), make-$v)

tools $(TOOLS)/generate-json: $(TOOLSSRC)
	@make -C $(TOOLS)

make-%: %
	@make -C $^

tdm: $(TOOLS)/generate-json
	@if [ -f $(TOOLS)/vep-config.txt ] ; then \
	  echo '*** TDM allocation as generated by the latest execution of ./run.sh, possibly including -xv option' ; \
	  echo '*** errors will be shown if the TDM allocation is erroneous' ; \
	$(TOOLS)/generate-json $(TOOLS)/vep-config.txt -json -tdm > /dev/null ; \
	else \
	  echo '*** TDM allocation as specified in all vep_*/vep-config.txt files (i.e. ./run.sh without -xv option)' ; \
	  echo '*** errors will be shown if the TDM allocation is erroneous' ; \
	  rm -f $(TOOLS)/vep-config.make ; \
	  grep -v -H '^[ 	]*#' vep_[1-9]*/vep-config.txt | sed -e 's/#.*//g' -e '/^[  ]*$$/d' -e 's+vep_\([0-9][0-9]*\)/vep-config.txt:+vep \1 +g' -e '/^vep [0-9][0-9]*[ 	]*$$/d'> $(TOOLS)/vep-config.make ; \
	  $(TOOLS)/generate-json $(TOOLS)/vep-config.make -json -tdm > /dev/null ; \
	  rm -f $(TOOLS)/vep-config.make ; \
	fi

mm memmap: $(TOOLS)/generate-json
	@if [ -f $(TOOLS)/vep-config.txt ] ; then \
	  echo '*** memory map as generated by the latest execution of ./run.sh, possibly including -xv option' ; \
	  echo '*** errors will be shown if the memory map is erroneous' ; \
	  $(TOOLS)/generate-json $(TOOLS)/vep-config.txt -json -mm > /dev/null ; \
	else \
	  echo '*** memory map as specified in all vep_*/vep-config.txt files (i.e. ./run.sh without -xv option)' ; \
	  echo '*** errors will be shown if the memory map is erroneous' ; \
	  grep -v -H '^[ 	]*#' vep_[1-9]*/vep-config.txt | sed -e 's/#.*//g' -e '/^[  ]*$$/d' -e 's+vep_\([0-9][0-9]*\)/vep-config.txt:+vep \1 +g' -e '/^vep [0-9][0-9]*[ 	]*$$/d'> $(TOOLS)/vep-config.make ; \
	  $(TOOLS)/generate-json $(TOOLS)/vep-config.make -json -mm > /dev/null ; \
	  rm -f $(TOOLS)/vep-config.make ; \
	fi

# only clean vep_0 & tools with veryclean
clean: $(foreach dir, $(VEPS), clean-$(dir)) 
	-rm -f $(TOOLS)/vep-config.make $(TOOLS)/vep-config.cmd $(TOOLS)/vep-config.txt

clean-%: %
	make -C $^ clean

veryclean: clean
	make -C vep_0 clean
	make -C $(TOOLS) veryclean

.PHONY: all make-vep_0 tools tdm mm memmap clean veryclean
